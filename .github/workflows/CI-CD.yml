name: CI-CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # [ì°¸ê³ ] í…ŒìŠ¤íŠ¸ë¥¼ ì•ˆ í•˜ë¯€ë¡œ ìƒë‹¨ì˜ env ë¸”ë¡ì€ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
    # ë¹Œë“œí•  ë•ŒëŠ” ë¹„ë°€ë²ˆí˜¸ ëª°ë¼ë„ ë©ë‹ˆë‹¤.

    steps:
      # 1ï¸âƒ£ ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      # 3ï¸âƒ£ Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸: -x test)
      - name: Build with Gradle
        uses: gradle/gradle-build-action@v3
        with:
          arguments: clean build -x test

      # 4ï¸âƒ£ Docker ë¹Œë“œ & í‘¸ì‹œ
      - name: Docker build and push
        run: |
          docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_PASSWORD }}
          docker build -t pc .
          docker tag pc ${{ secrets.DOCKERHUB_USERNAME }}/pc:${GITHUB_SHA::7}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pc:${GITHUB_SHA::7}

      # 5ï¸âƒ£ ì„œë²„ ë°°í¬ (ì—¬ê¸°ì„œ í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: 35.216.31.89
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GITHUB_SHA
          script: |
            # (1) ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€/ì‚­ì œ (ì—ëŸ¬ ë¬´ì‹œ)
            # í”„ë¡œì íŠ¸ ì´ë¦„ì„ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ ëª» ì°¾ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°•ì œ ì‚­ì œ ì‹œë„
            sudo docker rm -f pc_app || true
            
            # (2) .env íŒŒì¼ ìƒì„±
            # ğŸš¨ [ì¶”ê°€ë¨] í”„ë¡œì íŠ¸ ì´ë¦„ì„ í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì— ê³ ì • (ì´ê²Œ í•µì‹¬ í•´ê²°ì±…!)
            echo "COMPOSE_PROJECT_NAME=pc" > .env
            
            # ë‚˜ë¨¸ì§€ ë³€ìˆ˜ë“¤ (ì´ì–´ì“°ê¸° >>)
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env
            echo "DB_URL=${{ secrets.DB_URL }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> .env
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> .env
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
            echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}" >> .env
            echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}" >> .env
            
            # (3) ë¡œê·¸ì¸ & í’€
            sudo docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_PASSWORD }}
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/pc:${GITHUB_SHA::7}
            sudo docker tag ${{ secrets.DOCKERHUB_USERNAME }}/pc:${GITHUB_SHA::7} pc:latest
            
            # (4) ì‹¤í–‰
            # ğŸš¨ [ë³€ê²½] docker-compose (í•˜ì´í”ˆ) -> docker compose (ê³µë°±)
            # ğŸš¨ [ë³€ê²½] -p pc ì˜µì…˜ ì œê±° (ìœ„ì˜ .env íŒŒì¼ì—ì„œ ìë™ìœ¼ë¡œ ì½ìŒ)
            sudo docker compose up -d
            
            # (5) ì²­ì†Œ
            sudo docker image prune -f
